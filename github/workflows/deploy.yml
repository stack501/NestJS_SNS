name: ðŸš€ Deploy to NAS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ðŸ“¦ pnpm ì„¤ì¹˜
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ìºì‹œ
      uses: actions/cache@v3
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: pnpm install --frozen-lockfile
      
    - name: ðŸ” ë¦°íŠ¸ ê²€ì‚¬
      run: pnpm run lint
      
    - name: ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: pnpm run test
      
    - name: ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: pnpm run build

  deploy:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ” SSH Known Hosts ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.NAS_IP }} >> ~/.ssh/known_hosts
        
    - name: ðŸš€ NAS ì„œë²„ ë°°í¬
      uses: appleboy/ssh-action@v1.0.3
      env:
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        NAS_IP: ${{ secrets.NAS_IP }}  # â† Secretsì—ì„œ ê°€ì ¸ì˜´
      with:
        host: ${{ secrets.NAS_HOST }}
        username: ${{ secrets.NAS_USERNAME }}
        key: ${{ secrets.NAS_SSH_KEY }}
        port: ${{ secrets.NAS_PORT }}
        envs: GITHUB_SHA,GITHUB_REF,GITHUB_ACTOR,GITHUB_REPOSITORY,NAS_IP
        command_timeout: 15m
        script: |
          echo "======================================"
          echo "ðŸš€ GitHub Actions ë°°í¬ ì‹œìž‘"
          echo "======================================"
          echo "ðŸ“Š ë°°í¬ ì •ë³´:"
          echo "  - Repository: $GITHUB_REPOSITORY"
          echo "  - Branch: ${GITHUB_REF#refs/heads/}"
          echo "  - Commit: ${GITHUB_SHA:0:8}"
          echo "  - Actor: $GITHUB_ACTOR"
          echo "  - NAS IP: $NAS_IP"
          echo "  - Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================"
          
          cd ${{ secrets.NAS_PROJECT_PATH }}
          git log --oneline -3
          echo ""
          
          ./deploy.sh
          
          echo "======================================"
          echo "âœ… GitHub Actions ë°°í¬ ì™„ë£Œ"
          echo "ðŸŒ ì„œë¹„ìŠ¤ ì ‘ê·¼: http://$NAS_IP:3000"
          echo "ðŸ“š ë¬¸ì„œ ì ‘ê·¼: http://$NAS_IP:8080"
          echo "======================================"

  verify-deployment:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ” ë°°í¬ ê²€ì¦
      run: |
        echo "ðŸ” ë°°í¬ëœ ì„œë¹„ìŠ¤ ê²€ì¦ ì¤‘..."
        
        for i in {1..10}; do
          if curl -f -m 10 http://${{ secrets.NAS_IP }}:3000/health; then
            echo "âœ… API ì„œë¹„ìŠ¤ ì •ìƒ ë™ìž‘ í™•ì¸"
            break
          else
            echo "â³ API ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸° ì¤‘... ($i/10)"
            sleep 30
          fi
        done
        
        if curl -f -m 10 http://${{ secrets.NAS_IP }}:8080/; then
          echo "âœ… ë¬¸ì„œ ì„œë¹„ìŠ¤ ì •ìƒ ë™ìž‘ í™•ì¸"
        else
          echo "âŒ ë¬¸ì„œ ì„œë¹„ìŠ¤ ì ‘ê·¼ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "ðŸŽ‰ ë°°í¬ ê²€ì¦ ì™„ë£Œ!"

  deploy-summary:
    needs: [lint-and-test, deploy, verify-deployment]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ðŸš€ ë°°í¬ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY  
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ | ${{ needs.lint-and-test.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸš€ NAS ë°°í¬ | ${{ needs.deploy.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” ë°°í¬ ê²€ì¦ | ${{ needs.verify-deployment.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ìž‘ì„±ìž**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ ì„œë¹„ìŠ¤ ì ‘ê·¼ ë§í¬" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¡ **API ì„œë²„**: [http://${{ secrets.NAS_IP }}:3000](http://${{ secrets.NAS_IP }}:3000)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“š **API ë¬¸ì„œ**: [http://${{ secrets.NAS_IP }}:8080](http://${{ secrets.NAS_IP }}:8080)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **í—¬ìŠ¤ì²´í¬**: [http://${{ secrets.NAS_IP }}:3000/health](http://${{ secrets.NAS_IP }}:3000/health)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ **Swagger**: [http://${{ secrets.NAS_IP }}:3000/api-docs](http://${{ secrets.NAS_IP }}:3000/api-docs)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **GraphQL**: [http://${{ secrets.NAS_IP }}:3000/graphql](http://${{ secrets.NAS_IP }}:3000/graphql)" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ DDNS ì ‘ê·¼ (í¬íŠ¸í¬ì›Œë”© ì„¤ì • ì‹œ)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¡ **API ì„œë²„**: [http://ark1105.synology.me:3000](http://ark1105.synology.me:3000)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“š **API ë¬¸ì„œ**: [http://ark1105.synology.me:8080](http://ark1105.synology.me:8080)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy.result }}" = "failure" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë¡¤ë°± ëª…ë ¹ì–´**:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh master@[NAS_IP]" >> $GITHUB_STEP_SUMMARY
          echo "cd /volume1/docker/NestJS_SNS" >> $GITHUB_STEP_SUMMARY
          echo "./rollback.sh" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi