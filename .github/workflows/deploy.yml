name: ğŸš€ Deploy to NAS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ pnpm ì„¤ì¹˜ (ë²„ì „ í†µì¼)
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ
      uses: actions/cache@v3
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
        
    - name: ğŸ” pnpm ë° lock íŒŒì¼ ì •ë³´ í™•ì¸
      run: |
        echo "=== í™˜ê²½ ì •ë³´ ==="
        echo "Node.js ë²„ì „: $(node --version)"
        echo "pnpm ë²„ì „: $(pnpm --version)"
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "=== lock íŒŒì¼ ìƒíƒœ ==="
        if [ -f pnpm-lock.yaml ]; then
          echo "âœ… pnpm-lock.yaml ì¡´ì¬"
          echo "íŒŒì¼ í¬ê¸°: $(wc -c < pnpm-lock.yaml) bytes"
          echo "ì²« 5ì¤„:"
          head -5 pnpm-lock.yaml
        else
          echo "âŒ pnpm-lock.yaml ì—†ìŒ"
        fi
        echo "=== package.json í™•ì¸ ==="
        if [ -f package.json ]; then
          echo "âœ… package.json ì¡´ì¬"
        else
          echo "âŒ package.json ì—†ìŒ"
        fi
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "=== ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ ==="
        if [ -f pnpm-lock.yaml ]; then
          echo "ğŸ“¦ pnpm-lock.yaml ë°œê²¬ - lock íŒŒì¼ ê²€ì¦ ì¤‘..."
          if pnpm install --frozen-lockfile --dry-run; then
            echo "âœ… lock íŒŒì¼ í˜¸í™˜ë¨ - frozen-lockfile ëª¨ë“œ ì‚¬ìš©"
            pnpm install --frozen-lockfile
          else
            echo "âš ï¸ lock íŒŒì¼ ë¹„í˜¸í™˜ - lock íŒŒì¼ ì¬ìƒì„±"
            rm pnpm-lock.yaml
            pnpm install
            echo "ğŸ“ ìƒˆë¡œìš´ pnpm-lock.yaml ìƒì„±ë¨"
          fi
        else
          echo "âš ï¸ pnpm-lock.yaml ì—†ìŒ - ìƒˆë¡œ ìƒì„±"
          pnpm install
        fi
      
    - name: ğŸ” ë¦°íŠ¸ ê²€ì‚¬
      run: pnpm run lint
      
    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: pnpm run test
      
    - name: ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: pnpm run build

    # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì•Œë¦¼
    - name: ğŸ“¢ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#ci-cd-alerts'
        title: "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        fields: |
          {
            "Repository": "${{ github.repository }}",
            "Branch": "${{ github.ref_name }}",
            "Commit": "${{ github.sha }}",
            "Author": "${{ github.actor }}",
            "Workflow": "${{ github.workflow }}",
            "Failed Job": "lint-and-test"
          }
        text: |
          ğŸš¨ **í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!**
          
          ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë˜ëŠ” í…ŒìŠ¤íŠ¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
          GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”.
          
          **ì•¡ì…˜ ë§í¬**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    # ë°°í¬ ì‹œì‘ ì•Œë¦¼
    - name: ğŸ“¢ ë°°í¬ ì‹œì‘ ì•Œë¦¼
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#ci-cd-alerts",
            "username": "GitHub Actions",
            "icon_emoji": ":rocket:",
            "attachments": [{
              "color": "#2eb886",
              "pretext": "ğŸš€ **ë°°í¬ ì‹œì‘**",
              "title": "NAS ì„œë²„ ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤",
              "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "`${{ github.ref_name }}`",
                  "short": true
                },
                {
                  "title": "Commit",
                  "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>",
                  "short": true
                },
                {
                  "title": "Author",
                  "value": "${{ github.actor }}",
                  "short": true
                },
                {
                  "title": "DDNS Host",
                  "value": "`${{ secrets.NAS_DDNS }}`",
                  "short": true
                },
                {
                  "title": "Workflow",
                  "value": "${{ github.workflow }}",
                  "short": true
                }
              ],
              "footer": "GitHub Actions CI/CD",
              "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "ts": ${{ github.event.head_commit.timestamp && 'github.event.head_commit.timestamp' || 'null' }}
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: ğŸš€ NAS ì„œë²„ ë°°í¬ ë° ê²€ì¦ (DDNS)
      id: deploy
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.NAS_DDNS }}
        username: ${{ secrets.NAS_USERNAME }}
        password: ${{ secrets.NAS_PASSWORD }}
        port: ${{ secrets.NAS_PORT }}
        command_timeout: 30m
        script: |
          echo "======================================"
          echo "ğŸš€ GitHub Actions ë°°í¬ ì‹œì‘ (DDNS)"
          echo "======================================"
          echo "ğŸ“Š ë°°í¬ ì •ë³´:"
          echo "  - Repository: ${{ github.repository }}"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Actor: ${{ github.actor }}"
          echo "  - DDNS Host: ${{ secrets.NAS_DDNS }}"
          echo "  - Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================"
          
          cd ${{ secrets.NAS_PROJECT_PATH }}
          git log --oneline -3
          echo ""
          
          # deploy.sh ì‹¤í–‰ (DDNS í˜¸ìŠ¤íŠ¸ ì „ë‹¬)
          ./deploy.sh "${{ secrets.NAS_PASSWORD }}" "${{ secrets.NAS_DDNS }}"
          DEPLOY_EXIT_CODE=$?
          
          if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
            echo "======================================"
            echo "âœ… ë°°í¬ ì™„ë£Œ - ì¶”ê°€ ê²€ì¦ ìˆ˜í–‰"
            echo "======================================"
            
            # ë‚´ë¶€ì—ì„œ í¬íŠ¸ë³„ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ğŸ” í¬íŠ¸ë³„ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
            
            # API ì„œë²„ í¬íŠ¸ í™•ì¸
            if netstat -tuln | grep ":3000 " > /dev/null; then
              echo "âœ… API ì„œë²„ í¬íŠ¸ 3000 í™œì„±í™”"
            else
              echo "âŒ API ì„œë²„ í¬íŠ¸ 3000 ë¹„í™œì„±í™”"
              exit 1
            fi
            
            # ë¬¸ì„œ ì„œë²„ í¬íŠ¸ í™•ì¸
            if netstat -tuln | grep ":8080 " > /dev/null; then
              echo "âœ… ë¬¸ì„œ ì„œë²„ í¬íŠ¸ 8080 í™œì„±í™”"
            else
              echo "âš ï¸ ë¬¸ì„œ ì„œë²„ í¬íŠ¸ 8080 ë¹„í™œì„±í™” (ì„ íƒì )"
            fi
            
            # ë‹¤ì–‘í•œ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬)
            echo "ğŸ§ª API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ë‚´ë¶€)"
            
            # í—¬ìŠ¤ì²´í¬ (ë‚´ë¶€)
            if curl -f -s http://localhost:3000/health > /dev/null; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ API ì •ìƒ (ë‚´ë¶€)"
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ API ì‹¤íŒ¨ (ë‚´ë¶€)"
              exit 1
            fi
            
            # HTTPS í—¬ìŠ¤ì²´í¬ (ì—­ë°©í–¥ í”„ë¡ì‹œ)
            echo "ğŸ§ª HTTPS ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ì—­ë°©í–¥ í”„ë¡ì‹œ)"
            if curl -k -f -s "https://${{ secrets.NAS_DDNS }}/health" > /dev/null; then
              echo "âœ… HTTPS í—¬ìŠ¤ì²´í¬ ì •ìƒ"
            else
              echo "âš ï¸ HTTPS í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì—­ë°©í–¥ í”„ë¡ì‹œ ì„¤ì • í™•ì¸ í•„ìš”)"
            fi
            
            # Swagger UI í™•ì¸ (401ë„ ì •ìƒìœ¼ë¡œ ì²˜ë¦¬)
            SWAGGER_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "https://${{ secrets.NAS_DDNS }}/api" 2>/dev/null)
            if [ "$SWAGGER_STATUS" = "200" ] || [ "$SWAGGER_STATUS" = "401" ]; then
              echo "âœ… Swagger UI ì ‘ê·¼ ê°€ëŠ¥ (HTTP $SWAGGER_STATUS)"
            else
              echo "âš ï¸ Swagger UI ìƒíƒœ: HTTP $SWAGGER_STATUS"
            fi
            
            # GraphQL í™•ì¸ (400, 405ë„ ì •ìƒìœ¼ë¡œ ì²˜ë¦¬)
            GRAPHQL_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "https://${{ secrets.NAS_DDNS }}/graphql" 2>/dev/null)
            if [ "$GRAPHQL_STATUS" = "200" ] || [ "$GRAPHQL_STATUS" = "400" ] || [ "$GRAPHQL_STATUS" = "405" ]; then
              echo "âœ… GraphQL ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥ (HTTP $GRAPHQL_STATUS)"
            else
              echo "âš ï¸ GraphQL ìƒíƒœ: HTTP $GRAPHQL_STATUS"
            fi
            
            # Compodoc ë¬¸ì„œ í™•ì¸
            DOCS_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "https://${{ secrets.NAS_DDNS }}:444/" 2>/dev/null)
            if [ "$DOCS_STATUS" = "200" ]; then
              echo "âœ… Compodoc ë¬¸ì„œ ì ‘ê·¼ ê°€ëŠ¥ (HTTP $DOCS_STATUS)"
            else
              echo "âš ï¸ Compodoc ë¬¸ì„œ ìƒíƒœ: HTTP $DOCS_STATUS"
            fi
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ ìµœì¢… í™•ì¸
            echo "ğŸ“‹ ìµœì¢… ì»¨í…Œì´ë„ˆ ìƒíƒœ"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep sns-dev
            
            # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥  í™•ì¸
            echo "ğŸ“Š ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥ "
            echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ :"
            free -h | head -2
            echo "ë””ìŠ¤í¬ ì‚¬ìš©ë¥ :"
            df -h | grep -E "(/$|/volume1)"
            
            # ë°°í¬ ì„±ê³µ ì •ë³´ë¥¼ GitHub Actionsë¡œ ì „ë‹¬
            echo "DEPLOY_SUCCESS=true" >> $GITHUB_ENV
            echo "SWAGGER_STATUS=$SWAGGER_STATUS" >> $GITHUB_ENV
            echo "GRAPHQL_STATUS=$GRAPHQL_STATUS" >> $GITHUB_ENV
            echo "DOCS_STATUS=$DOCS_STATUS" >> $GITHUB_ENV
            
            echo "======================================"
            echo "âœ… GitHub Actions ë°°í¬ ë° ê²€ì¦ ì™„ë£Œ"
            echo "ğŸŒ HTTPS ì„œë¹„ìŠ¤ ì ‘ê·¼:"
            echo "  ğŸ“¡ API: https://${{ secrets.NAS_DDNS }}"
            echo "  ğŸ“‹ Swagger: https://${{ secrets.NAS_DDNS }}/api"
            echo "  ğŸš€ GraphQL: https://${{ secrets.NAS_DDNS }}/graphql"
            echo "  ğŸ” í—¬ìŠ¤ì²´í¬: https://${{ secrets.NAS_DDNS }}/health"
            echo "  ğŸ“š ë¬¸ì„œ: https://${{ secrets.NAS_DDNS }}:444"
            echo "ğŸ’¡ ì—­ë°©í–¥ í”„ë¡ì‹œë¥¼ í†µí•œ HTTPS ì ‘ê·¼ì´ ê¶Œì¥ë©ë‹ˆë‹¤"
            echo "======================================"
          else
            echo "âŒ GitHub Actions ë°°í¬ ì‹¤íŒ¨ (Exit Code: $DEPLOY_EXIT_CODE)"
            exit $DEPLOY_EXIT_CODE
          fi
        
    # ë°°í¬ ì„±ê³µ ì•Œë¦¼
    - name: ğŸ“¢ ë°°í¬ ì„±ê³µ ì•Œë¦¼
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#ci-cd-alerts'
        title: "âœ… ë°°í¬ ì„±ê³µ"
        fields: |
          {
            "Repository": "${{ github.repository }}",
            "Branch": "${{ github.ref_name }}",
            "Commit": "${{ github.sha }}",
            "Author": "${{ github.actor }}",
            "DDNS Host": "${{ secrets.NAS_DDNS }}",
            "Deployment Time": "ì•½ ${{ github.event.head_commit.timestamp && 'ê³„ì‚°ì¤‘' || 'N/A' }}"
          }
        text: |
          ğŸ‰ **NAS ì„œë²„ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**
          
          ğŸŒ **ì„œë¹„ìŠ¤ ì ‘ê·¼ ë§í¬**
          â€¢ ğŸ“¡ API ì„œë²„: https://${{ secrets.NAS_DDNS }}
          â€¢ ğŸ“‹ Swagger UI: https://${{ secrets.NAS_DDNS }}/api
          â€¢ ğŸš€ GraphQL: https://${{ secrets.NAS_DDNS }}/graphql
          â€¢ ğŸ” í—¬ìŠ¤ì²´í¬: https://${{ secrets.NAS_DDNS }}/health
          â€¢ ğŸ“š ë¬¸ì„œ: https://${{ secrets.NAS_DDNS }}:444
          
          âœ… **ê²€ì¦ ì™„ë£Œ**
          â€¢ ì»¨í…Œì´ë„ˆ ìƒíƒœ: ì •ìƒ
          â€¢ ë‚´ë¶€ API: ì •ìƒ
          â€¢ HTTPS í”„ë¡ì‹œ: ì •ìƒ
          â€¢ ë°ì´í„°ë² ì´ìŠ¤: ì—°ê²°ë¨
          
          **ì•¡ì…˜ ë¡œê·¸**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    # ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
    - name: ğŸ“¢ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#ci-cd-alerts'
        title: "âŒ ë°°í¬ ì‹¤íŒ¨"
        fields: |
          {
            "Repository": "${{ github.repository }}",
            "Branch": "${{ github.ref_name }}",
            "Commit": "${{ github.sha }}",
            "Author": "${{ github.actor }}",
            "DDNS Host": "${{ secrets.NAS_DDNS }}",
            "Failed Step": "${{ job.status }}"
          }
        text: |
          ğŸš¨ **NAS ì„œë²„ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!**
          
          ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
          
          ğŸ”§ **ë¡¤ë°± ëª…ë ¹ì–´**
          ```bash
          ssh ${{ secrets.NAS_USERNAME }}@${{ secrets.NAS_DDNS }}
          cd ${{ secrets.NAS_PROJECT_PATH }}
          ./rollback.sh
          ```
          
          ğŸ“Š **ë¬¸ì œ ì§„ë‹¨**
          1. **ì•¡ì…˜ ë¡œê·¸ í™•ì¸**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          2. **ì„œë²„ ë¡œê·¸ í™•ì¸**: `docker logs sns-dev-app`
          3. **ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸**: `docker ps -a`
          4. **ë¦¬ì†ŒìŠ¤ í™•ì¸**: `df -h && free -h`
          
          ğŸ†˜ **ê¸´ê¸‰ ì—°ë½ì²˜**
          â€¢ ë‹´ë‹¹ì: ${{ github.actor }}
          â€¢ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ ë° í—¬ìŠ¤ì²´í¬
  post-deploy-monitoring:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: â³ ë°°í¬ ì•ˆì •í™” ëŒ€ê¸°
      run: |
        echo "ğŸ”„ ì„œë¹„ìŠ¤ ì™„ì „ ì‹œì‘ì„ ìœ„í•´ 60ì´ˆ ëŒ€ê¸° ì¤‘..."
        sleep 60
      
    - name: ğŸ” ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
      id: healthcheck
      run: |
        echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ ì ê²€ ì‹œì‘..."
        
        # í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰
        echo "ğŸ“¡ API í—¬ìŠ¤ì²´í¬ ì¤‘..."
        HEALTH_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" --max-time 10 "https://${{ secrets.NAS_DDNS }}/health" || echo "000")
        echo "Health API Status: $HEALTH_STATUS"
        
        echo "ğŸ“‹ Swagger API ì²´í¬ ì¤‘..."
        API_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" --max-time 10 "https://${{ secrets.NAS_DDNS }}/api" || echo "000")
        echo "Swagger API Status: $API_STATUS"
        
        echo "ğŸš€ GraphQL ì²´í¬ ì¤‘..."
        GRAPHQL_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" --max-time 10 "https://${{ secrets.NAS_DDNS }}/graphql" || echo "000")
        echo "GraphQL Status: $GRAPHQL_STATUS"
        
        echo "ğŸ“š ë¬¸ì„œ ì„œë¹„ìŠ¤ ì²´í¬ ì¤‘..."
        DOCS_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" --max-time 10 "https://${{ secrets.NAS_DDNS }}:444/" || echo "000")
        echo "Docs Status: $DOCS_STATUS"
        
        # GitHub Actions ì¶œë ¥ìœ¼ë¡œ ì „ë‹¬
        echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
        echo "api_status=$API_STATUS" >> $GITHUB_OUTPUT
        echo "graphql_status=$GRAPHQL_STATUS" >> $GITHUB_OUTPUT
        echo "docs_status=$DOCS_STATUS" >> $GITHUB_OUTPUT
        
        # ì „ì²´ ìƒíƒœ íŒë‹¨
        if [ "$HEALTH_STATUS" = "200" ]; then
          echo "overall_status=healthy" >> $GITHUB_OUTPUT
          echo "status_color=good" >> $GITHUB_OUTPUT
          echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
        else
          echo "overall_status=unhealthy" >> $GITHUB_OUTPUT
          echo "status_color=danger" >> $GITHUB_OUTPUT
          echo "status_emoji=âš ï¸" >> $GITHUB_OUTPUT
        fi
        
        # ê° ì„œë¹„ìŠ¤ë³„ ìƒíƒœ í…ìŠ¤íŠ¸ ìƒì„±
        HEALTH_TEXT=$([ "$HEALTH_STATUS" = "200" ] && echo "âœ… ì •ìƒ" || echo "âŒ ì´ìƒ")
        API_TEXT=$([ "$API_STATUS" = "200" ] || [ "$API_STATUS" = "401" ] && echo "âœ… ì •ìƒ" || echo "âŒ ì´ìƒ")
        GRAPHQL_TEXT=$([ "$GRAPHQL_STATUS" = "200" ] || [ "$GRAPHQL_STATUS" = "400" ] || [ "$GRAPHQL_STATUS" = "405" ] && echo "âœ… ì •ìƒ" || echo "âŒ ì´ìƒ")
        DOCS_TEXT=$([ "$DOCS_STATUS" = "200" ] && echo "âœ… ì •ìƒ" || echo "âŒ ì´ìƒ")
        
        echo "health_text=$HEALTH_TEXT" >> $GITHUB_OUTPUT
        echo "api_text=$API_TEXT" >> $GITHUB_OUTPUT
        echo "graphql_text=$GRAPHQL_TEXT" >> $GITHUB_OUTPUT
        echo "docs_text=$DOCS_TEXT" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¢ ì„œë¹„ìŠ¤ ìƒíƒœ ì•Œë¦¼
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#ci-cd-alerts",
            "username": "Health Monitor",
            "icon_emoji": ":stethoscope:",
            "attachments": [{
              "color": "${{ steps.healthcheck.outputs.status_color }}",
              "pretext": "${{ steps.healthcheck.outputs.status_emoji }} **ë°°í¬ í›„ ì„œë¹„ìŠ¤ ìƒíƒœ ì ê²€ ì™„ë£Œ**",
              "title": "${{ steps.healthcheck.outputs.overall_status == 'healthy' && 'ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤' || 'ì¼ë¶€ ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤' }}",
              "title_link": "https://${{ secrets.NAS_DDNS }}",
              "fields": [
                {
                  "title": "ğŸ” Health Check API",
                  "value": "${{ steps.healthcheck.outputs.health_text }} (HTTP ${{ steps.healthcheck.outputs.health_status }})",
                  "short": true
                },
                {
                  "title": "ğŸ“‹ Swagger API",
                  "value": "${{ steps.healthcheck.outputs.api_text }} (HTTP ${{ steps.healthcheck.outputs.api_status }})",
                  "short": true
                },
                {
                  "title": "ğŸš€ GraphQL",
                  "value": "${{ steps.healthcheck.outputs.graphql_text }} (HTTP ${{ steps.healthcheck.outputs.graphql_status }})",
                  "short": true
                },
                {
                  "title": "ğŸ“š Documentation",
                  "value": "${{ steps.healthcheck.outputs.docs_text }} (HTTP ${{ steps.healthcheck.outputs.docs_status }})",
                  "short": true
                },
                {
                  "title": "ğŸŒ DDNS Host",
                  "value": "`${{ secrets.NAS_DDNS }}`",
                  "short": true
                },
                {
                  "title": "â±ï¸ ì ê²€ ì‹œê°„",
                  "value": "$(date '+%Y-%m-%d %H:%M:%S UTC')",
                  "short": true
                }
              ],
              "footer": "Post-Deploy Health Check",
              "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "ts": ${{ github.event.head_commit.timestamp && 'github.event.head_commit.timestamp' || 'null' }}
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

    # ì„œë¹„ìŠ¤ ë¬¸ì œ ê°ì§€ ì‹œ ì¶”ê°€ ì•Œë¦¼
    - name: ğŸš¨ ì„œë¹„ìŠ¤ ì´ìƒ ê¸´ê¸‰ ì•Œë¦¼
      if: steps.healthcheck.outputs.overall_status == 'unhealthy'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#ci-cd-urgent'
        title: "ğŸš¨ ê¸´ê¸‰: ë°°í¬ í›„ ì„œë¹„ìŠ¤ ìƒíƒœ ì´ìƒ"
        fields: |
          {
            "Repository": "${{ github.repository }}",
            "DDNS Host": "${{ secrets.NAS_DDNS }}",
            "Health Status": "${{ steps.healthcheck.outputs.health_status }}",
            "Detection Time": "$(date '+%Y-%m-%d %H:%M:%S UTC')",
            "Action Required": "ì¦‰ì‹œ í™•ì¸ í•„ìš”"
          }
        text: |
          ğŸš¨ **ê¸´ê¸‰: ë°°í¬ëŠ” ì„±ê³µí–ˆì§€ë§Œ ì„œë¹„ìŠ¤ ìƒíƒœì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤!**
          
          ğŸ“Š **ë¬¸ì œ ìƒí™©**
          â€¢ Health Check: ${{ steps.healthcheck.outputs.health_text }} (HTTP ${{ steps.healthcheck.outputs.health_status }})
          â€¢ ë©”ì¸ APIê°€ ì‘ë‹µí•˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤
          
          ğŸ”§ **ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­**
          1. ì„œë²„ ìƒíƒœ í™•ì¸: `ssh ${{ secrets.NAS_USERNAME }}@${{ secrets.NAS_DDNS }}`
          2. ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸: `docker logs sns-dev-app --tail=50`
          3. ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘: `docker restart sns-dev-app`
          4. í•„ìš”ì‹œ ë¡¤ë°±: `./rollback.sh`
          
          ğŸ†˜ **ë‹´ë‹¹ì ì¦‰ì‹œ í™•ì¸ í•„ìš”**
          
          **ëª¨ë‹ˆí„°ë§ ë§í¬**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-summary:
    needs: [lint-and-test, deploy, post-deploy-monitoring]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ğŸš€ ë°°í¬ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY  
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ | ${{ needs.lint-and-test.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸš€ NAS ë°°í¬ ë° ê²€ì¦ | ${{ needs.deploy.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ” ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ | ${{ needs.post-deploy-monitoring.result == 'success' && 'âœ… ì™„ë£Œ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‘ì„±ì**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **DDNS í˜¸ìŠ¤íŠ¸**: \`${{ secrets.NAS_DDNS }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ ì„œë¹„ìŠ¤ ì ‘ê·¼ ë§í¬ (HTTPS ê¶Œì¥)" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ”’ HTTPS ì ‘ê·¼ (ì—­ë°©í–¥ í”„ë¡ì‹œ)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¡ **API ì„œë²„**: [https://${{ secrets.NAS_DDNS }}](https://${{ secrets.NAS_DDNS }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“‹ **Swagger UI**: [https://${{ secrets.NAS_DDNS }}/api](https://${{ secrets.NAS_DDNS }}/api)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸš€ **GraphQL**: [https://${{ secrets.NAS_DDNS }}/graphql](https://${{ secrets.NAS_DDNS }}/graphql)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **í—¬ìŠ¤ì²´í¬**: [https://${{ secrets.NAS_DDNS }}/health](https://${{ secrets.NAS_DDNS }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“š **ë¬¸ì„œ**: [https://${{ secrets.NAS_DDNS }}:444](https://${{ secrets.NAS_DDNS }}:444)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’¡ ì°¸ê³ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë‚´ë¶€ ë° HTTPS ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ HTTPS ì ‘ê·¼ì´ ê¶Œì¥ë©ë‹ˆë‹¤ (SSL ì¸ì¦ì„œ ì ìš©)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ DDNSë¥¼ í†µí•œ ì•ˆì •ì ì¸ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š ëª¨ë‹ˆí„°ë§: \`docker exec sns-dev-monitor ./monitor.sh\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy.result }}" = "failure" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë¡¤ë°± ëª…ë ¹ì–´**:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh ${{ secrets.NAS_USERNAME }}@${{ secrets.NAS_DDNS }}" >> $GITHUB_STEP_SUMMARY
          echo "cd ${{ secrets.NAS_PROJECT_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "./rollback.sh" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

    # ìµœì¢… íŒŒì´í”„ë¼ì¸ ìš”ì•½ ì•Œë¦¼
    - name: ğŸ“¢ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ìš”ì•½ ì•Œë¦¼
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#ci-cd-summary",
            "username": "Pipeline Summary",
            "icon_emoji": ":clipboard:",
            "attachments": [{
              "color": "${{ needs.deploy.result == 'success' && 'good' || 'danger' }}",
              "pretext": "ğŸ“Š **CI/CD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ìš”ì•½**",
              "title": "${{ needs.deploy.result == 'success' && 'âœ… ì „ì²´ íŒŒì´í”„ë¼ì¸ ì„±ê³µ' || 'âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨' }}",
              "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "fields": [
                {
                  "title": "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬",
                  "value": "${{ needs.lint-and-test.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}",
                  "short": true
                },
                {
                  "title": "ğŸš€ NAS ë°°í¬",
                  "value": "${{ needs.deploy.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}",
                  "short": true
                },
                {
                  "title": "ğŸ” ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§",
                  "value": "${{ needs.post-deploy-monitoring.result == 'success' && 'âœ… ì™„ë£Œ' || needs.post-deploy-monitoring.result == 'skipped' && 'â­ï¸ ìƒëµë¨' || 'âŒ ì‹¤íŒ¨' }}",
                  "short": true
                },
                {
                  "title": "â±ï¸ ì´ ì‹¤í–‰ ì‹œê°„",
                  "value": "ì•½ ${{ github.event.head_commit.timestamp && 'ê³„ì‚° ì¤‘...' || 'N/A' }}",
                  "short": true
                },
                {
                  "title": "ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€",
                  "value": "${{ github.event.head_commit.message || 'Manual trigger' }}",
                  "short": false
                }
              ],
              "footer": "GitHub Actions CI/CD Pipeline â€¢ ${{ github.repository }}",
              "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "ts": ${{ github.event.head_commit.timestamp && 'github.event.head_commit.timestamp' || 'null' }}
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

    # ì£¼ê°„ í†µê³„ë¥¼ ìœ„í•œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (ì„ íƒì )
    - name: ğŸ“ˆ ë°°í¬ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      if: success()
      run: |
        # í–¥í›„ ë¶„ì„ì„ ìœ„í•œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        echo "ğŸ“Š ë°°í¬ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì¤‘..."
        echo "Repository: ${{ github.repository }}" 
        echo "Branch: ${{ github.ref_name }}"
        echo "Author: ${{ github.actor }}"
        echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "Deploy Result: ${{ needs.deploy.result }}"
        echo "Test Result: ${{ needs.lint-and-test.result }}"
        echo "Monitor Result: ${{ needs.post-deploy-monitoring.result }}"
        
        # í–¥í›„ ì£¼ê°„/ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„±ì— í™œìš© ê°€ëŠ¥
