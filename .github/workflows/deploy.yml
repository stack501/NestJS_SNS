name: ğŸš€ Deploy to NAS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ pnpm ì„¤ì¹˜ (ë²„ì „ í†µì¼)
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ
      uses: actions/cache@v3
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
        
    - name: ğŸ” pnpm ë° lock íŒŒì¼ ì •ë³´ í™•ì¸
      run: |
        echo "=== í™˜ê²½ ì •ë³´ ==="
        echo "Node.js ë²„ì „: $(node --version)"
        echo "pnpm ë²„ì „: $(pnpm --version)"
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "=== lock íŒŒì¼ ìƒíƒœ ==="
        if [ -f pnpm-lock.yaml ]; then
          echo "âœ… pnpm-lock.yaml ì¡´ì¬"
          echo "íŒŒì¼ í¬ê¸°: $(wc -c < pnpm-lock.yaml) bytes"
          echo "ì²« 5ì¤„:"
          head -5 pnpm-lock.yaml
        else
          echo "âŒ pnpm-lock.yaml ì—†ìŒ"
        fi
        echo "=== package.json í™•ì¸ ==="
        if [ -f package.json ]; then
          echo "âœ… package.json ì¡´ì¬"
        else
          echo "âŒ package.json ì—†ìŒ"
        fi
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "=== ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ ==="
        if [ -f pnpm-lock.yaml ]; then
          echo "ğŸ“¦ pnpm-lock.yaml ë°œê²¬ - lock íŒŒì¼ ê²€ì¦ ì¤‘..."
          # lock íŒŒì¼ í˜¸í™˜ì„± í™•ì¸
          if pnpm install --frozen-lockfile --dry-run; then
            echo "âœ… lock íŒŒì¼ í˜¸í™˜ë¨ - frozen-lockfile ëª¨ë“œ ì‚¬ìš©"
            pnpm install --frozen-lockfile
          else
            echo "âš ï¸ lock íŒŒì¼ ë¹„í˜¸í™˜ - lock íŒŒì¼ ì¬ìƒì„±"
            rm pnpm-lock.yaml
            pnpm install
            echo "ğŸ“ ìƒˆë¡œìš´ pnpm-lock.yaml ìƒì„±ë¨"
          fi
        else
          echo "âš ï¸ pnpm-lock.yaml ì—†ìŒ - ìƒˆë¡œ ìƒì„±"
          pnpm install
        fi
      
    - name: ğŸ” ë¦°íŠ¸ ê²€ì‚¬
      run: pnpm run lint
      
    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: pnpm run test
      
    - name: ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: pnpm run build

  deploy:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸš€ NAS ì„œë²„ ë°°í¬ ë° ê²€ì¦ (DDNS)
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.NAS_DDNS }}
        username: ${{ secrets.NAS_USERNAME }}
        password: ${{ secrets.NAS_PASSWORD }}
        port: ${{ secrets.NAS_PORT }}
        command_timeout: 30m
        script: |
          echo "======================================"
          echo "ğŸš€ GitHub Actions ë°°í¬ ì‹œì‘ (DDNS)"
          echo "======================================"
          echo "ğŸ“Š ë°°í¬ ì •ë³´:"
          echo "  - Repository: ${{ github.repository }}"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Actor: ${{ github.actor }}"
          echo "  - DDNS Host: ${{ secrets.NAS_DDNS }}"
          echo "  - Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================"
          
          cd ${{ secrets.NAS_PROJECT_PATH }}
          git log --oneline -3
          echo ""
          
          # deploy.sh ì‹¤í–‰ (DDNS í˜¸ìŠ¤íŠ¸ ì „ë‹¬)
          ./deploy.sh "${{ secrets.NAS_PASSWORD }}" "${{ secrets.NAS_DDNS }}"
          DEPLOY_EXIT_CODE=$?
          
          if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
            echo "======================================"
            echo "âœ… ë°°í¬ ì™„ë£Œ - ì¶”ê°€ ê²€ì¦ ìˆ˜í–‰"
            echo "======================================"
            
            # ë‚´ë¶€ì—ì„œ í¬íŠ¸ë³„ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ğŸ” í¬íŠ¸ë³„ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
            
            # API ì„œë²„ í¬íŠ¸ í™•ì¸
            if netstat -tuln | grep ":3000 " > /dev/null; then
              echo "âœ… API ì„œë²„ í¬íŠ¸ 3000 í™œì„±í™”"
            else
              echo "âŒ API ì„œë²„ í¬íŠ¸ 3000 ë¹„í™œì„±í™”"
              exit 1
            fi
            
            # ë¬¸ì„œ ì„œë²„ í¬íŠ¸ í™•ì¸
            if netstat -tuln | grep ":8080 " > /dev/null; then
              echo "âœ… ë¬¸ì„œ ì„œë²„ í¬íŠ¸ 8080 í™œì„±í™”"
            else
              echo "âš ï¸ ë¬¸ì„œ ì„œë²„ í¬íŠ¸ 8080 ë¹„í™œì„±í™” (ì„ íƒì )"
            fi
            
            # ë‹¤ì–‘í•œ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬)
            echo "ğŸ§ª API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ë‚´ë¶€)"
            
            # í—¬ìŠ¤ì²´í¬ (ë‚´ë¶€)
            if curl -f -s http://localhost:3000/health > /dev/null; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ API ì •ìƒ (ë‚´ë¶€)"
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ API ì‹¤íŒ¨ (ë‚´ë¶€)"
              exit 1
            fi
            
            # HTTPS í—¬ìŠ¤ì²´í¬ (ì—­ë°©í–¥ í”„ë¡ì‹œ)
            echo "ğŸ§ª HTTPS ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ì—­ë°©í–¥ í”„ë¡ì‹œ)"
            if curl -k -f -s "https://${{ secrets.NAS_DDNS }}/health" > /dev/null; then
              echo "âœ… HTTPS í—¬ìŠ¤ì²´í¬ ì •ìƒ"
            else
              echo "âš ï¸ HTTPS í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì—­ë°©í–¥ í”„ë¡ì‹œ ì„¤ì • í™•ì¸ í•„ìš”)"
            fi
            
            # Swagger UI í™•ì¸ (401ë„ ì •ìƒìœ¼ë¡œ ì²˜ë¦¬)
            SWAGGER_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "https://${{ secrets.NAS_DDNS }}/api" 2>/dev/null)
            if [ "$SWAGGER_STATUS" = "200" ] || [ "$SWAGGER_STATUS" = "401" ]; then
              echo "âœ… Swagger UI ì ‘ê·¼ ê°€ëŠ¥ (HTTP $SWAGGER_STATUS)"
            else
              echo "âš ï¸ Swagger UI ìƒíƒœ: HTTP $SWAGGER_STATUS"
            fi
            
            # GraphQL í™•ì¸ (400, 405ë„ ì •ìƒìœ¼ë¡œ ì²˜ë¦¬)
            GRAPHQL_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "https://${{ secrets.NAS_DDNS }}/graphql" 2>/dev/null)
            if [ "$GRAPHQL_STATUS" = "200" ] || [ "$GRAPHQL_STATUS" = "400" ] || [ "$GRAPHQL_STATUS" = "405" ]; then
              echo "âœ… GraphQL ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥ (HTTP $GRAPHQL_STATUS)"
            else
              echo "âš ï¸ GraphQL ìƒíƒœ: HTTP $GRAPHQL_STATUS"
            fi
            
            # Compodoc ë¬¸ì„œ í™•ì¸
            DOCS_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "https://${{ secrets.NAS_DDNS }}:444/" 2>/dev/null)
            if [ "$DOCS_STATUS" = "200" ]; then
              echo "âœ… Compodoc ë¬¸ì„œ ì ‘ê·¼ ê°€ëŠ¥ (HTTP $DOCS_STATUS)"
            else
              echo "âš ï¸ Compodoc ë¬¸ì„œ ìƒíƒœ: HTTP $DOCS_STATUS"
            fi
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ ìµœì¢… í™•ì¸
            echo "ğŸ“‹ ìµœì¢… ì»¨í…Œì´ë„ˆ ìƒíƒœ"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep sns-dev
            
            # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥  í™•ì¸
            echo "ğŸ“Š ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥ "
            echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ :"
            free -h | head -2
            echo "ë””ìŠ¤í¬ ì‚¬ìš©ë¥ :"
            df -h | grep -E "(/$|/volume1)"
            
            echo "======================================"
            echo "âœ… GitHub Actions ë°°í¬ ë° ê²€ì¦ ì™„ë£Œ"
            echo "ğŸŒ HTTPS ì„œë¹„ìŠ¤ ì ‘ê·¼:"
            echo "  ğŸ“¡ API: https://${{ secrets.NAS_DDNS }}"
            echo "  ğŸ“‹ Swagger: https://${{ secrets.NAS_DDNS }}/api"
            echo "  ğŸš€ GraphQL: https://${{ secrets.NAS_DDNS }}/graphql"
            echo "  ğŸ” í—¬ìŠ¤ì²´í¬: https://${{ secrets.NAS_DDNS }}/health"
            echo "  ğŸ“š ë¬¸ì„œ: https://${{ secrets.NAS_DDNS }}:444"
            echo "ğŸ’¡ ì—­ë°©í–¥ í”„ë¡ì‹œë¥¼ í†µí•œ HTTPS ì ‘ê·¼ì´ ê¶Œì¥ë©ë‹ˆë‹¤"
            echo "======================================"
          else
            echo "âŒ GitHub Actions ë°°í¬ ì‹¤íŒ¨ (Exit Code: $DEPLOY_EXIT_CODE)"
            exit $DEPLOY_EXIT_CODE
          fi

  deploy-summary:
    needs: [lint-and-test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ğŸš€ ë°°í¬ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY  
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ | ${{ needs.lint-and-test.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸš€ NAS ë°°í¬ ë° ê²€ì¦ | ${{ needs.deploy.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‘ì„±ì**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **DDNS í˜¸ìŠ¤íŠ¸**: \`${{ secrets.NAS_DDNS }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ ì„œë¹„ìŠ¤ ì ‘ê·¼ ë§í¬ (HTTPS ê¶Œì¥)" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ”’ HTTPS ì ‘ê·¼ (ì—­ë°©í–¥ í”„ë¡ì‹œ)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¡ **API ì„œë²„**: [https://${{ secrets.NAS_DDNS }}](https://${{ secrets.NAS_DDNS }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“‹ **Swagger UI**: [https://${{ secrets.NAS_DDNS }}/api](https://${{ secrets.NAS_DDNS }}/api)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸš€ **GraphQL**: [https://${{ secrets.NAS_DDNS }}/graphql](https://${{ secrets.NAS_DDNS }}/graphql)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **í—¬ìŠ¤ì²´í¬**: [https://${{ secrets.NAS_DDNS }}/health](https://${{ secrets.NAS_DDNS }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“š **ë¬¸ì„œ**: [https://${{ secrets.NAS_DDNS }}:444](https://${{ secrets.NAS_DDNS }}:444)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’¡ ì°¸ê³ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë‚´ë¶€ ë° HTTPS ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ HTTPS ì ‘ê·¼ì´ ê¶Œì¥ë©ë‹ˆë‹¤ (SSL ì¸ì¦ì„œ ì ìš©)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ DDNSë¥¼ í†µí•œ ì•ˆì •ì ì¸ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š ëª¨ë‹ˆí„°ë§: \`docker exec sns-dev-monitor ./monitor.sh\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy.result }}" = "failure" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë¡¤ë°± ëª…ë ¹ì–´**:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh ${{ secrets.NAS_USERNAME }}@${{ secrets.NAS_DDNS }}" >> $GITHUB_STEP_SUMMARY
          echo "cd ${{ secrets.NAS_PROJECT_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "./rollback.sh" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
