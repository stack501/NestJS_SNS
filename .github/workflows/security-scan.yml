name: ğŸ›¡ï¸ Security Scan (pnpm)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    name: ğŸ” Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        # npm cache ì œê±° - pnpm ì‚¬ìš©
    
    # ğŸ”§ pnpm ì„¤ì¹˜ ë° ì„¤ì •
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        run_install: false
    
    - name: ğŸ—‚ï¸ Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
    
    - name: ğŸš€ Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    # ğŸ”§ pnpmìœ¼ë¡œ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ Install Dependencies with pnpm
      run: |
        echo "ğŸ“¦ pnpmìœ¼ë¡œ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."
        
        # pnpm-lock.yaml ì¡´ì¬ í™•ì¸
        if [[ -f pnpm-lock.yaml ]]; then
          echo "âœ… pnpm-lock.yaml ë°œê²¬ - frozen lockfileë¡œ ì„¤ì¹˜"
          pnpm install --frozen-lockfile
        else
          echo "âš ï¸ pnpm-lock.yamlì´ ì—†ìŒ - ìƒˆë¡œ ìƒì„±"
          pnpm install
        fi
        
        # ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸ ë° ìˆ˜ì •
        echo "ğŸ” ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸ ì¤‘..."
        pnpm audit || echo "âš ï¸ ì·¨ì•½ì  ë°œê²¬ë¨"
        
        # ë³´ì•ˆ ê´€ë ¨ dev dependencies ì¶”ê°€
        pnpm add -D eslint-plugin-security || true
        
        echo "âœ… pnpm ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
    
    # ===== ì½”ë“œ ë³´ì•ˆ ë¶„ì„ =====
    
    - name: ğŸ”¬ Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-and-quality
    
    - name: ğŸ”¬ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: ğŸ” ESLint Security Scan
      run: |
        echo "ğŸ” ESLint ë³´ì•ˆ ìŠ¤ìº” ì‹œì‘..."
        pnpm exec eslint . --ext .ts,.js \
          --rule "no-eval: error" \
          --rule "no-implied-eval: error" \
          --rule "no-new-func: error" \
          --format @microsoft/eslint-formatter-sarif \
          --output-file eslint-security-results.sarif || true
        
        if [[ -f eslint-security-results.sarif ]]; then
          echo "âœ… ESLint SARIF íŒŒì¼ ìƒì„±ë¨"
        fi
      continue-on-error: true
    
    - name: ğŸ›¡ï¸ Semgrep Security Scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/nodejs
        generateSarif: "1"
      continue-on-error: true
    
    # ===== ì˜ì¡´ì„± ë³´ì•ˆ ë¶„ì„ (pnpm ë²„ì „) =====
    
    - name: ğŸ“¦ pnpm Security Audit
      run: |
        echo "## ğŸ“¦ pnpm Audit Results" >> $GITHUB_STEP_SUMMARY
        
        # pnpm audit ì‹¤í–‰ (JSON í˜•ì‹ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í…ìŠ¤íŠ¸ë¡œ)
        echo "ğŸ” pnpm audit ì‹¤í–‰ ì¤‘..."
        pnpm audit > pnpm-audit-results.txt 2>&1 || echo "âš ï¸ ì·¨ì•½ì  ë°œê²¬ë¨"
        
        # ê²°ê³¼ íŒŒì‹± ë° ìš”ì•½
        if [[ -f pnpm-audit-results.txt ]]; then
          AUDIT_OUTPUT=$(cat pnpm-audit-results.txt)
          
          # ì·¨ì•½ì  ê°œìˆ˜ ì¶”ì¶œ (ëŒ€ëµì )
          ISSUES=$(echo "$AUDIT_OUTPUT" | grep -c "â”‚" || echo "0")
          
          echo "- **ì´ ì´ìŠˆ ìˆ˜:** $ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒì„¸ ê²°ê³¼:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 pnpm-audit-results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # ê²½ê³  ì¶œë ¥
          if [[ $ISSUES -gt 5 ]]; then
            echo "::warning::Multiple vulnerabilities found in dependencies"
          fi
        fi
        
        # npm auditë„ ì¶”ê°€ë¡œ ì‹¤í–‰ (í˜¸í™˜ì„±ì„ ìœ„í•´)
        echo "ğŸ” ì¶”ê°€ npm audit ì‹¤í–‰..."
        npm audit --json > npm-audit-results.json 2>/dev/null || true
        
        if [[ -f npm-audit-results.json ]] && [[ -s npm-audit-results.json ]]; then
          CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
          HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
          MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit-results.json)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š npm audit ì¶”ê°€ ë¶„ì„" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- **High:** $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate:** $MODERATE" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ” Dependency Security Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: critical
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC, 0BSD, BSD-2-Clause
      continue-on-error: true
    
    # ===== ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ë¶„ì„ =====
    
    - name: ğŸ³ Dockerfile Security Check
      if: hashFiles('Dockerfile') != ''
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-results.sarif
        failure-threshold: error
      continue-on-error: true
    
    - name: ğŸ” Trivy Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
      continue-on-error: true
    
    # ===== ì‹œí¬ë¦¿ ê²€ì¶œ =====
    
    - name: ğŸ” GitLeaks Secret Detection
      uses: gitleaks/gitleaks-action@v2
      continue-on-error: true
    
    - name: ğŸ· TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --only-verified
      continue-on-error: true
    
    # ===== SARIF ì—…ë¡œë“œ =====
    
    - name: ğŸ“¤ Check and Upload SARIF Results
      if: always()
      run: |
        echo "ğŸ“¤ SARIF íŒŒì¼ í™•ì¸ ì¤‘..."
        
        SARIF_FILES=$(find . -name "*.sarif" -type f 2>/dev/null || true)
        SARIF_COUNT=$(echo "$SARIF_FILES" | grep -c "\.sarif" || echo "0")
        
        if [[ $SARIF_COUNT -gt 0 ]]; then
          echo "âœ… SARIF íŒŒì¼ ${SARIF_COUNT}ê°œ ë°œê²¬:"
          echo "$SARIF_FILES" | while read file; do
            if [[ -n "$file" ]]; then
              echo "  ğŸ“„ $file ($(stat -c%s "$file" 2>/dev/null || echo "0") bytes)"
            fi
          done
          echo "SARIF_AVAILABLE=true" >> $GITHUB_ENV
        else
          echo "â„¹ï¸ SARIF íŒŒì¼ì´ ì—†ìŒ - ì—…ë¡œë“œ ìŠ¤í‚µ"
          echo "SARIF_AVAILABLE=false" >> $GITHUB_ENV
        fi
    
    - name: ğŸ“¤ Upload SARIF Files
      if: always() && env.SARIF_AVAILABLE == 'true'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: .
      continue-on-error: true
    
    # ===== ê²°ê³¼ ìš”ì•½ =====
    - name: ğŸ“Š Generate Security Summary
      if: always()
      run: |
        echo "# ğŸ›¡ï¸ Security Scan Summary (pnpm)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Package Manager:** pnpm ğŸ“¦" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ” Completed Scans" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CodeQL | Static code analysis | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| ESLint Security | JavaScript security rules | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Semgrep | Pattern-based security | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| pnpm Audit | Node.js dependencies (pnpm) | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| npm Audit | Additional dependency check | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependency Review | GitHub dependency check | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Trivy | Filesystem vulnerabilities | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Hadolint | Dockerfile security | $([ -f 'Dockerfile' ] && echo 'âœ…' || echo 'â­ï¸') |" >> $GITHUB_STEP_SUMMARY
        echo "| GitLeaks | Git secret detection | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| TruffleHog | Secret pattern matching | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ’° Total Cost: **\$0.00** ğŸ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“Š View Results" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” **Security Tab**: [View all findings](${{ github.server_url }}/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ **Code Scanning**: [Detailed analysis](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” **Secret Scanning**: [Secret detection results](${{ github.server_url }}/${{ github.repository }}/security/secret-scanning)" >> $GITHUB_STEP_SUMMARY
    
    # ğŸ¨ ì˜ˆìœ Slack ì•Œë¦¼
    - name: ğŸ“± Send Beautiful Slack Notification
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [[ -n "$SLACK_WEBHOOK_URL" ]]; then
          echo "ğŸ“± ì˜ˆìœ Slack ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS_COLOR="good"
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="PASSED"
            STATUS_DETAIL="ëª¨ë“  ë³´ì•ˆ ìŠ¤ìº”ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (pnpm ê¸°ë°˜)"
          else
            STATUS_COLOR="warning"
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="ISSUES FOUND"
            STATUS_DETAIL="ì¼ë¶€ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤. (pnpm ê¸°ë°˜)"
          fi
          
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHORT:0:7}"
          
          cat > slack_message.json << EOF
          {
            "username": "Security Scanner Bot (pnpm)",
            "icon_emoji": ":shield:",
            "attachments": [
              {
                "color": "$STATUS_COLOR",
                "fallback": "Security Scan Results for ${{ github.repository }}",
                "author_name": "ğŸ›¡ï¸ Security Scan Pipeline (pnpm)",
                "author_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "title": "$STATUS_EMOJI Security Scan $STATUS_TEXT",
                "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "text": "$STATUS_DETAIL",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "\`${{ github.repository }}\`",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "\`${{ github.ref_name }}\`",
                    "short": true
                  },
                  {
                    "title": "Package Manager",
                    "value": "ğŸ“¦ pnpm",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|$COMMIT_SHORT>",
                    "short": true
                  },
                  {
                    "title": "Triggered by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Scan Time",
                    "value": "$CURRENT_TIME",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions Security Scanner (pnpm)",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": $(date +%s)
              },
              {
                "color": "#36a64f",
                "title": "ğŸ” Security Tools Executed (9/9)",
                "fields": [
                  {
                    "title": "Static Analysis",
                    "value": "â€¢ CodeQL Analysis âœ…\nâ€¢ ESLint Security Rules âœ…\nâ€¢ Semgrep Pattern Matching âœ…",
                    "short": true
                  },
                  {
                    "title": "Dependency Security",
                    "value": "â€¢ pnpm Audit âœ…\nâ€¢ npm Audit (ì¶”ê°€) âœ…\nâ€¢ GitHub Dependency Review âœ…",
                    "short": true
                  },
                  {
                    "title": "Container Security",
                    "value": "â€¢ Trivy Filesystem Scan âœ…\nâ€¢ Dockerfile Security Check âœ…",
                    "short": true
                  },
                  {
                    "title": "Secret Detection",
                    "value": "â€¢ GitLeaks Detection âœ…\nâ€¢ TruffleHog Pattern Scan âœ…",
                    "short": true
                  }
                ],
                "footer": "ğŸ’° Total Cost: \$0.00 (Free Tools Only) | ğŸ“¦ Powered by pnpm"
              },
              {
                "color": "#1f77b4",
                "title": "ğŸ“Š Quick Actions",
                "actions": [
                  {
                    "type": "button",
                    "text": "ğŸ” View Security Tab",
                    "url": "${{ github.server_url }}/${{ github.repository }}/security"
                  },
                  {
                    "type": "button",
                    "text": "ğŸ“‹ Detailed Results",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    "type": "button",
                    "text": "ğŸ“ˆ Code Scanning",
                    "url": "${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
                  }
                ]
              }
            ]
          }
          EOF
          
          if curl -X POST -H 'Content-type: application/json' \
            --data @slack_message.json \
            "$SLACK_WEBHOOK_URL"; then
            echo "âœ… ì˜ˆìœ Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ!"
          else
            echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          fi
          
          rm -f slack_message.json
        else
          echo "â„¹ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ - ì•Œë¦¼ ìŠ¤í‚µ"
        fi
      continue-on-error: true
