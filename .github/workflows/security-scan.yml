name: 🛡️ Security Scan (pnpm)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    name: 🔍 Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: 📦 Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        run_install: false
    
    - name: 🗂️ Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
    
    - name: 🚀 Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    - name: 📦 Install Dependencies with pnpm
      run: |
        echo "📦 pnpm으로 의존성 설치 시작..."
        
        if [[ -f pnpm-lock.yaml ]]; then
          echo "✅ pnpm-lock.yaml 발견 - frozen lockfile로 설치"
          pnpm install --frozen-lockfile
        else
          echo "⚠️ pnpm-lock.yaml이 없음 - 새로 생성"
          pnpm install
        fi
        
        echo "🔍 보안 취약점 확인 중..."
        pnpm audit || echo "⚠️ 취약점 발견됨"
        
        pnpm add -D eslint-plugin-security || true
        echo "✅ pnpm 의존성 설치 완료"
    
    # ===== 코드 보안 분석 =====
    
    - name: 🔬 Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-and-quality
    
    - name: 🔬 Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: 🔍 ESLint Security Scan
      run: |
        echo "🔍 ESLint 보안 스캔 시작..."
        pnpm exec eslint . --ext .ts,.js \
          --rule "no-eval: error" \
          --rule "no-implied-eval: error" \
          --rule "no-new-func: error" \
          --format @microsoft/eslint-formatter-sarif \
          --output-file eslint-security-results.sarif || true
        
        if [[ -f eslint-security-results.sarif ]]; then
          echo "✅ ESLint SARIF 파일 생성됨"
        fi
      continue-on-error: true
    
    - name: 🛡️ Semgrep Security Scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/nodejs
        generateSarif: "1"
      continue-on-error: true
    
    # ===== 의존성 보안 분석 =====
    
    - name: 📦 pnpm Security Audit
      run: |
        echo "## 📦 pnpm Audit Results" >> $GITHUB_STEP_SUMMARY
        
        echo "🔍 pnpm audit 실행 중..."
        pnpm audit > pnpm-audit-results.txt 2>&1 || echo "⚠️ 취약점 발견됨"
        
        if [[ -f pnpm-audit-results.txt ]]; then
          AUDIT_OUTPUT=$(cat pnpm-audit-results.txt)
          ISSUES=$(echo "$AUDIT_OUTPUT" | grep -c "│" || echo "0")
          
          echo "- **총 이슈 수:** $ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- **상세 결과:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 pnpm-audit-results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          if [[ $ISSUES -gt 5 ]]; then
            echo "::warning::Multiple vulnerabilities found in dependencies"
          fi
        fi
        
        echo "🔍 추가 npm audit 실행..."
        npm audit --json > npm-audit-results.json 2>/dev/null || true
        
        if [[ -f npm-audit-results.json ]] && [[ -s npm-audit-results.json ]]; then
          CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
          HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
          MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit-results.json)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 npm audit 추가 분석" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- **High:** $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate:** $MODERATE" >> $GITHUB_STEP_SUMMARY
        fi
    
    # 🔧 수정: PR에서만 실행
    - name: 🔍 Dependency Security Review (PR Only)
      if: github.event_name == 'pull_request'
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: critical
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC, 0BSD, BSD-2-Clause
      continue-on-error: true
    
    # ===== 컨테이너 보안 분석 =====
    
    - name: 🐳 Dockerfile Security Check
      if: hashFiles('Dockerfile') != ''
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-results.sarif
        failure-threshold: error
      continue-on-error: true
    
    - name: 🔍 Trivy Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
      continue-on-error: true
    
    # ===== 시크릿 검출 (수정됨) =====
    
    # 🔧 수정: GitLeaks 대신 detect-secrets 사용
    - name: 🔐 Detect Secrets (GitLeaks 대안)
      run: |
        echo "🔍 시크릿 검출 시작..."
        
        # Python과 detect-secrets 설치
        pip install detect-secrets
        
        # baseline 파일이 없으면 생성
        if [[ ! -f .secrets.baseline ]]; then
          echo "📄 .secrets.baseline 생성 중..."
          detect-secrets scan --all-files --baseline .secrets.baseline || true
        fi
        
        # 시크릿 스캔 실행
        echo "🔍 새로운 시크릿 검사 중..."
        detect-secrets scan --all-files --baseline .secrets.baseline --fail-on-found || echo "⚠️ 새로운 시크릿 발견"
        
        # 결과 요약
        SECRET_COUNT=$(jq '.results | to_entries | length' .secrets.baseline 2>/dev/null || echo "0")
        echo "## 🔐 Secret Detection Results" >> $GITHUB_STEP_SUMMARY
        echo "- **잠재적 시크릿 수:** $SECRET_COUNT" >> $GITHUB_STEP_SUMMARY
        
        if [[ $SECRET_COUNT -gt 0 ]]; then
          echo "::warning::Potential secrets detected: $SECRET_COUNT"
        fi
      continue-on-error: true
    
    # 🔧 수정: TruffleHog 조건부 실행
    - name: 🐷 TruffleHog Secret Scan (PR Only)
      if: github.event_name == 'pull_request'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha }}
        head: ${{ github.event.pull_request.head.sha }}
        extra_args: --only-verified
      continue-on-error: true
    
    # push 이벤트용 TruffleHog (전체 스캔)
    - name: 🐷 TruffleHog Full Filesystem Scan (Push Event)
      if: github.event_name == 'push'
      run: |
        echo "🐷 TruffleHog 전체 파일시스템 스캔..."
        
        # TruffleHog 설치
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
        
        # 파일시스템 스캔
        trufflehog filesystem . --only-verified --json > trufflehog-results.json || true
        
        # 결과 요약
        if [[ -f trufflehog-results.json ]]; then
          SECRET_FOUND=$(jq '. | length' trufflehog-results.json 2>/dev/null || echo "0")
          echo "## 🐷 TruffleHog Results" >> $GITHUB_STEP_SUMMARY
          echo "- **검증된 시크릿:** $SECRET_FOUND" >> $GITHUB_STEP_SUMMARY
          
          if [[ $SECRET_FOUND -gt 0 ]]; then
            echo "::warning::Verified secrets found: $SECRET_FOUND"
          fi
        fi
      continue-on-error: true
    
    # ===== SARIF 업로드 =====
    
    - name: 📤 Check and Upload SARIF Results
      if: always()
      run: |
        echo "📤 SARIF 파일 확인 중..."
        
        SARIF_FILES=$(find . -name "*.sarif" -type f 2>/dev/null || true)
        SARIF_COUNT=$(echo "$SARIF_FILES" | grep -c "\.sarif" || echo "0")
        
        if [[ $SARIF_COUNT -gt 0 ]]; then
          echo "✅ SARIF 파일 ${SARIF_COUNT}개 발견:"
          echo "$SARIF_FILES" | while read file; do
            if [[ -n "$file" ]]; then
              echo "  📄 $file ($(stat -c%s "$file" 2>/dev/null || echo "0") bytes)"
            fi
          done
          echo "SARIF_AVAILABLE=true" >> $GITHUB_ENV
        else
          echo "ℹ️ SARIF 파일이 없음 - 업로드 스킵"
          echo "SARIF_AVAILABLE=false" >> $GITHUB_ENV
        fi
    
    - name: 📤 Upload SARIF Files
      if: always() && env.SARIF_AVAILABLE == 'true'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: .
      continue-on-error: true
    
    # ===== 결과 요약 =====
    - name: 📊 Generate Security Summary
      if: always()
      run: |
        echo "# 🛡️ Security Scan Summary (pnpm)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Package Manager:** pnpm 📦" >> $GITHUB_STEP_SUMMARY
        echo "**Event Type:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 🔍 Completed Scans" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CodeQL | Static code analysis | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| ESLint Security | JavaScript security rules | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| Semgrep | Pattern-based security | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| pnpm Audit | Node.js dependencies (pnpm) | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| npm Audit | Additional dependency check | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependency Review | GitHub dependency check | $([ '${{ github.event_name }}' == 'pull_request' ] && echo '✅' || echo '⏭️') |" >> $GITHUB_STEP_SUMMARY
        echo "| Trivy | Filesystem vulnerabilities | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| Hadolint | Dockerfile security | $([ -f 'Dockerfile' ] && echo '✅' || echo '⏭️') |" >> $GITHUB_STEP_SUMMARY
        echo "| detect-secrets | Secret pattern detection | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "| TruffleHog | Advanced secret scanning | ✅ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 💰 Total Cost: **\$0.00** 🎉" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 📊 View Results" >> $GITHUB_STEP_SUMMARY
        echo "- 🔍 **Security Tab**: [View all findings](${{ github.server_url }}/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
        echo "- 📋 **Code Scanning**: [Detailed analysis](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
        echo "- 🔐 **Secret Scanning**: [Secret detection results](${{ github.server_url }}/${{ github.repository }}/security/secret-scanning)" >> $GITHUB_STEP_SUMMARY
    
    # 🔧 수정된 Slack 알림 (HERE-document 문법 수정)
    - name: 📱 Send Beautiful Slack Notification
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [[ -n "$SLACK_WEBHOOK_URL" ]]; then
          echo "📱 예쁜 Slack 알림 전송 중..."
          
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS_COLOR="good"
            STATUS_EMOJI="✅"
            STATUS_TEXT="PASSED"
            STATUS_DETAIL="모든 보안 스캔이 성공적으로 완료되었습니다. (pnpm 기반)"
          else
            STATUS_COLOR="warning"
            STATUS_EMOJI="⚠️"
            STATUS_TEXT="ISSUES FOUND"
            STATUS_DETAIL="일부 보안 이슈가 발견되었습니다. 검토가 필요합니다. (pnpm 기반)"
          fi
          
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHORT:0:7}"
          
          # JSON 메시지를 별도 파일로 생성
          cat > slack_message.json << 'SLACK_EOF'
{
  "username": "Security Scanner Bot (pnpm)",
  "icon_emoji": ":shield:",
  "attachments": [
    {
      "color": "STATUS_COLOR_PLACEHOLDER",
      "fallback": "Security Scan Results",
      "author_name": "🛡️ Security Scan Pipeline (pnpm)",
      "author_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
      "title": "STATUS_EMOJI_PLACEHOLDER Security Scan STATUS_TEXT_PLACEHOLDER",
      "title_link": "WORKFLOW_URL_PLACEHOLDER",
      "text": "STATUS_DETAIL_PLACEHOLDER",
      "fields": [
        {
          "title": "Repository",
          "value": "`REPOSITORY_PLACEHOLDER`",
          "short": true
        },
        {
          "title": "Branch",
          "value": "`BRANCH_PLACEHOLDER`",
          "short": true
        },
        {
          "title": "Package Manager",
          "value": "📦 pnpm",
          "short": true
        },
        {
          "title": "Event",
          "value": "EVENT_TYPE_PLACEHOLDER",
          "short": true
        },
        {
          "title": "Commit",
          "value": "<COMMIT_URL_PLACEHOLDER|COMMIT_SHORT_PLACEHOLDER>",
          "short": true
        },
        {
          "title": "Triggered by",
          "value": "ACTOR_PLACEHOLDER",
          "short": true
        },
        {
          "title": "Scan Time",
          "value": "CURRENT_TIME_PLACEHOLDER",
          "short": false
        }
      ],
      "footer": "GitHub Actions Security Scanner (pnpm)",
      "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
      "ts": TIMESTAMP_PLACEHOLDER
    },
    {
      "color": "#36a64f",
      "title": "🔍 Security Tools Executed",
      "fields": [
        {
          "title": "Static Analysis",
          "value": "• CodeQL Analysis ✅\n• ESLint Security Rules ✅\n• Semgrep Pattern Matching ✅",
          "short": true
        },
        {
          "title": "Dependency Security",
          "value": "• pnpm Audit ✅\n• npm Audit (추가) ✅\n• GitHub Dependency Review ✅",
          "short": true
        },
        {
          "title": "Container Security",
          "value": "• Trivy Filesystem Scan ✅\n• Dockerfile Security Check ✅",
          "short": true
        },
        {
          "title": "Secret Detection",
          "value": "• detect-secrets ✅\n• TruffleHog Pattern Scan ✅",
          "short": true
        }
      ],
      "footer": "💰 Total Cost: $0.00 (Free Tools Only) | 📦 Powered by pnpm"
    },
    {
      "color": "#1f77b4",
      "title": "📊 Quick Actions",
      "actions": [
        {
          "type": "button",
          "text": "🔍 View Security Tab",
          "url": "SECURITY_URL_PLACEHOLDER"
        },
        {
          "type": "button",
          "text": "📋 Detailed Results",
          "url": "WORKFLOW_URL_PLACEHOLDER"
        },
        {
          "type": "button",
          "text": "📈 Code Scanning",
          "url": "CODE_SCANNING_URL_PLACEHOLDER"
        }
      ]
    }
  ]
}
SLACK_EOF
          
          # 플레이스홀더 치환
          sed -i "s|STATUS_COLOR_PLACEHOLDER|$STATUS_COLOR|g" slack_message.json
          sed -i "s|STATUS_EMOJI_PLACEHOLDER|$STATUS_EMOJI|g" slack_message.json
          sed -i "s|STATUS_TEXT_PLACEHOLDER|$STATUS_TEXT|g" slack_message.json
          sed -i "s|STATUS_DETAIL_PLACEHOLDER|$STATUS_DETAIL|g" slack_message.json
          sed -i "s|REPOSITORY_PLACEHOLDER|${{ github.repository }}|g" slack_message.json
          sed -i "s|BRANCH_PLACEHOLDER|${{ github.ref_name }}|g" slack_message.json
          sed -i "s|EVENT_TYPE_PLACEHOLDER|${{ github.event_name }}|g" slack_message.json
          sed -i "s|COMMIT_SHORT_PLACEHOLDER|$COMMIT_SHORT|g" slack_message.json
          sed -i "s|ACTOR_PLACEHOLDER|${{ github.actor }}|g" slack_message.json
          sed -i "s|CURRENT_TIME_PLACEHOLDER|$CURRENT_TIME|g" slack_message.json
          sed -i "s|TIMESTAMP_PLACEHOLDER|$(date +%s)|g" slack_message.json
          sed -i "s|WORKFLOW_URL_PLACEHOLDER|${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|g" slack_message.json
          sed -i "s|COMMIT_URL_PLACEHOLDER|${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|g" slack_message.json
          sed -i "s|SECURITY_URL_PLACEHOLDER|${{ github.server_url }}/${{ github.repository }}/security|g" slack_message.json
          sed -i "s|CODE_SCANNING_URL_PLACEHOLDER|${{ github.server_url }}/${{ github.repository }}/security/code-scanning|g" slack_message.json
          
          # Slack으로 전송
          if curl -X POST -H 'Content-type: application/json' \
            --data @slack_message.json \
            "$SLACK_WEBHOOK_URL"; then
            echo "✅ 예쁜 Slack 알림 전송 완료!"
          else
            echo "⚠️ Slack 알림 전송 실패"
          fi
          
          rm -f slack_message.json
        else
          echo "ℹ️ SLACK_WEBHOOK_URL이 설정되지 않음 - 알림 스킵"
        fi
      continue-on-error: true
