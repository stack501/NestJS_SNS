name: ğŸ›¡ï¸ Corrected Free Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # =====================================
  # ğŸ’¯ ì™„ì „ ë¬´ë£Œ ë³´ì•ˆ ìŠ¤ìº” (ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
  # =====================================
  free-security-scan:
    name: ğŸ” Free Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # GitLeaksê°€ ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ìŠ¤ìº”í•˜ê¸° ìœ„í•´
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
    
    # ===== ì½”ë“œ ë³´ì•ˆ ë¶„ì„ =====
    
    # GitHub CodeQL (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ”¬ Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-and-quality
    
    - name: ğŸ”¬ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    # ESLint ë³´ì•ˆ ê·œì¹™ (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ” ESLint Security Scan
      run: |
        # ë³´ì•ˆ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
        npm install --save-dev eslint-plugin-security || true
        
        # ë³´ì•ˆ ê·œì¹™ìœ¼ë¡œ ìŠ¤ìº”
        npx eslint . --ext .ts,.js \
          --rule "no-eval: error" \
          --rule "no-implied-eval: error" \
          --rule "no-new-func: error" \
          --format @microsoft/eslint-formatter-sarif \
          --output-file eslint-security-results.sarif || true
      continue-on-error: true
    
    # Semgrep Community (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ›¡ï¸ Semgrep Security Scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/nodejs
        generateSarif: "1"
      continue-on-error: true
    
    # ===== ì˜ì¡´ì„± ë³´ì•ˆ ë¶„ì„ =====
    
    # NPM Audit (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ“¦ NPM Security Audit
      run: |
        echo "## ğŸ“¦ NPM Audit Results" >> $GITHUB_STEP_SUMMARY
        
        # JSON ê²°ê³¼ ìƒì„±
        npm audit --json > npm-audit-results.json 2>/dev/null || true
        
        # ê°€ë…ì„± ìˆëŠ” ê²°ê³¼ ì¶œë ¥
        npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilities found"
        
        # ìš”ì•½ ì •ë³´ ì¶”ì¶œ
        if [[ -f npm-audit-results.json ]]; then
          CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
          HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
          MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit-results.json)
          
          echo "- **Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- **High:** $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate:** $MODERATE" >> $GITHUB_STEP_SUMMARY
          
          # ì‹¬ê°í•œ ì·¨ì•½ì ì´ ìˆìœ¼ë©´ ê²½ê³ 
          if [[ $CRITICAL -gt 0 ]] || [[ $HIGH -gt 3 ]]; then
            echo "::warning::High/Critical vulnerabilities found: Critical($CRITICAL), High($HIGH)"
          fi
        fi
    
    # GitHub Dependency Review (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ” Dependency Security Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: critical
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC, 0BSD, BSD-2-Clause
      continue-on-error: true
    
    # OSV Scanner (Google, ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ” OSV Vulnerability Scanner
      uses: google/osv-scanner-action@v1
      with:
        scan-args: |-
          -r
          --skip-git
          .
      continue-on-error: true
    
    # ===== ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ë¶„ì„ =====
    
    # Dockerfile ë³´ì•ˆ ê²€ì‚¬ (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ³ Dockerfile Security Check
      if: hashFiles('Dockerfile') != ''
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-results.sarif
        failure-threshold: error
      continue-on-error: true
    
    # Trivy íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº” (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ” Trivy Filesystem Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
      continue-on-error: true
    
    # ===== ì‹œí¬ë¦¿ ê²€ì¶œ =====
    
    # GitLeaks (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”!)
    - name: ğŸ” GitLeaks Secret Detection
      uses: gitleaks/gitleaks-action@v2
      # env ì„¹ì…˜ ì™„ì „ ì œê±° - ì‹œí¬ë¦¿ ë¶ˆí•„ìš”!
      continue-on-error: true
    
    # TruffleHog (ì™„ì „ ë¬´ë£Œ, ì‹œí¬ë¦¿ ë¶ˆí•„ìš”)
    - name: ğŸ· TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --only-verified
      continue-on-error: true
    
    # ===== SARIF ê²°ê³¼ ì—…ë¡œë“œ =====
    - name: ğŸ“¤ Upload Security Scan Results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: .
    
    # ===== ê²°ê³¼ ìš”ì•½ =====
    - name: ğŸ“Š Generate Security Summary
      if: always()
      run: |
        echo "# ğŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ” Completed Scans" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CodeQL | Static code analysis | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| ESLint Security | JavaScript security rules | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Semgrep | Pattern-based security | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| NPM Audit | Node.js dependencies | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| OSV Scanner | Vulnerability database | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Trivy | Filesystem vulnerabilities | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Hadolint | Dockerfile security | $([ -f 'Dockerfile' ] && echo 'âœ…' || echo 'â­ï¸') |" >> $GITHUB_STEP_SUMMARY
        echo "| GitLeaks | Git secret detection | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| TruffleHog | Secret pattern matching | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ’° Total Cost: **\$0.00** ğŸ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“Š View Results" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” **Security Tab**: [View all findings](${{ github.server_url }}/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ **Code Scanning**: [Detailed analysis](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” **Secret Scanning**: [Secret detection results](${{ github.server_url }}/${{ github.repository }}/security/secret-scanning)" >> $GITHUB_STEP_SUMMARY

  # =====================================
  # ğŸ“± ì„ íƒì  ì•Œë¦¼ (SLACK_WEBHOOK_URLì´ ìˆëŠ” ê²½ìš°ë§Œ)
  # =====================================
  notify-results:
    name: ğŸ“± Notification
    runs-on: ubuntu-latest
    needs: free-security-scan
    if: always() && vars.SLACK_WEBHOOK_URL != ''
    
    steps:
    - name: ğŸ“± Send Slack Notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ needs.free-security-scan.result }}
        fields: repo,message,commit,author,ref,workflow
        webhook_url: ${{ vars.SLACK_WEBHOOK_URL }}  # secrets ëŒ€ì‹  vars ì‚¬ìš© ê°€ëŠ¥
        channel: '#security-alerts'
        text: |
          ğŸ›¡ï¸ **Free Security Scan Completed**
          
          **Repository:** ${{ github.repository }}
          **Status:** ${{ needs.free-security-scan.result == 'success' && 'âœ… CLEAN' || 'âš ï¸ ISSUES FOUND' }}
          **Branch:** ${{ github.ref_name }}
          **Cost:** $0.00 ğŸ’°
          
          **Scans Performed:**
          â€¢ CodeQL Static Analysis
          â€¢ NPM Dependency Audit  
          â€¢ Container Security Check
          â€¢ Secret Pattern Detection
          â€¢ Infrastructure Security
          
          ğŸ“Š **View Details:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ğŸ” **Security Tab:** ${{ github.server_url }}/${{ github.repository }}/security
      continue-on-error: true
